#!/usr/bin/python

import sys, os, signal
import Queue
from optparse import OptionParser
from common import util
from client.event import Event
from client.network_thread import NetworkThread

def main():
    options, args = handle_args()
    for s in [signal.SIGINT, signal.SIGTERM]:
        signal.signal(s, signal_handler)

    net_thread = NetworkThread(options.host, options.port)
    net_thread.start()

    # The Event-loop
    while True:
        try:
            event = util.global_msg_queue.get(True, 0.1)
            if event.origin == 'NetworkThread':
                print event.data.to_string()
            elif event.origin == 'signal_handler':
                net_thread.shutdown()
                break
        except Queue.Empty:
            pass

def signal_handler(signum, frame):
    util.global_msg_queue.put(Event("signal_handler", signum))

def handle_args():
    parser = OptionParser()
    parser.set_defaults(host='localhost', port=5006)
    parser.add_option('-s', '--host',
            action='store', type='string', dest='host',
            help='The host to connect to.')
    parser.add_option('-p', '--port',
            action='store', type='int', dest='port',
            help='The port to use.')
    return parser.parse_args()

if __name__ == "__main__":
    status = 0
    try:
        main()
    except Exception as e:
        import traceback
        traceback.print_exc()
        status = 1
    print 'exit status: %d' % status
    sys.exit(status)
